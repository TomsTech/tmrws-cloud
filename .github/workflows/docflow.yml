# DocFlow: Auto-Generate Documentation
# Part of Portfolio V2.0 standardization - keeps docs fresh automatically
#
# What it does:
# - Generates project statistics (file counts, test counts)
# - Creates folder structure diagram
# - Builds documentation index
# - Runs weekly + on push to main

name: "DocFlow: Generate Documentation"

on:
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'docs/**'
      - '*.md'
      - 'docflow.config.json'
  workflow_dispatch:
    inputs:
      regenerate_all:
        description: 'Force regenerate all documentation'
        required: false
        default: false
        type: boolean
  schedule:
    # Weekly documentation refresh (Monday 6 AM UTC / 4 PM AEST)
    - cron: '0 6 * * 1'

permissions:
  contents: write

env:
  DOCS_DIR: docs/generated

jobs:
  generate-statistics:
    name: "Generate Project Statistics"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Statistics
        run: |
          mkdir -p $DOCS_DIR

          # Read config if exists
          if [ -f "docflow.config.json" ]; then
            SRC_DIR=$(jq -r '.paths.src // "src/"' docflow.config.json)
          else
            SRC_DIR="src/"
          fi

          cat > $DOCS_DIR/STATISTICS.md << 'EOF'
          # Project Statistics

          > Auto-generated by DocFlow. Do not edit manually.
          > Last updated: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## File Counts

          | Category | Count |
          |----------|-------|
          EOF

          # Count files by type
          JS_COUNT=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" 2>/dev/null | grep -v node_modules | wc -l || echo "0")
          PY_COUNT=$(find . -name "*.py" 2>/dev/null | grep -v __pycache__ | wc -l || echo "0")
          PS_COUNT=$(find . -name "*.ps1" -o -name "*.psm1" 2>/dev/null | wc -l || echo "0")
          PHP_COUNT=$(find . -name "*.php" 2>/dev/null | grep -v vendor | wc -l || echo "0")
          GO_COUNT=$(find . -name "*.go" 2>/dev/null | wc -l || echo "0")
          MD_COUNT=$(find . -name "*.md" 2>/dev/null | wc -l || echo "0")
          TEST_COUNT=$(find . -name "*.test.*" -o -name "*.spec.*" -o -name "*_test.*" -o -name "*.Tests.ps1" 2>/dev/null | wc -l || echo "0")
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | wc -l || echo "0")

          echo "| JavaScript/TypeScript | $JS_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| Python | $PY_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| PowerShell | $PS_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| PHP | $PHP_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| Go | $GO_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| Documentation (MD) | $MD_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| Test Files | $TEST_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| GitHub Workflows | $WORKFLOW_COUNT |" >> $DOCS_DIR/STATISTICS.md

          # Add git stats
          echo "" >> $DOCS_DIR/STATISTICS.md
          echo "## Repository Stats" >> $DOCS_DIR/STATISTICS.md
          echo "" >> $DOCS_DIR/STATISTICS.md
          echo "| Metric | Value |" >> $DOCS_DIR/STATISTICS.md
          echo "|--------|-------|" >> $DOCS_DIR/STATISTICS.md

          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          CONTRIBUTOR_COUNT=$(git shortlog -sn --no-merges 2>/dev/null | wc -l || echo "0")
          FIRST_COMMIT=$(git log --reverse --format="%cs" 2>/dev/null | head -1 || echo "Unknown")
          LAST_COMMIT=$(git log -1 --format="%cs" 2>/dev/null || echo "Unknown")

          echo "| Total Commits | $COMMIT_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| Contributors | $CONTRIBUTOR_COUNT |" >> $DOCS_DIR/STATISTICS.md
          echo "| First Commit | $FIRST_COMMIT |" >> $DOCS_DIR/STATISTICS.md
          echo "| Last Commit | $LAST_COMMIT |" >> $DOCS_DIR/STATISTICS.md

      - name: Upload Statistics
        uses: actions/upload-artifact@v4
        with:
          name: statistics
          path: ${{ env.DOCS_DIR }}/STATISTICS.md
          retention-days: 7

  generate-structure:
    name: "Generate Folder Structure"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Structure Diagram
        run: |
          mkdir -p $DOCS_DIR/diagrams

          cat > $DOCS_DIR/diagrams/FOLDER_STRUCTURE.md << 'EOF'
          # Folder Structure

          > Auto-generated by DocFlow. Do not edit manually.

          ## Directory Tree

          ```
          EOF

          # Generate tree (exclude common noise)
          tree -L 3 -I 'node_modules|vendor|__pycache__|.git|.venv|dist|build|coverage' --dirsfirst -a 2>/dev/null >> $DOCS_DIR/diagrams/FOLDER_STRUCTURE.md || \
            find . -type d -not -path '*/\.*' -not -path '*/node_modules/*' -not -path '*/vendor/*' | head -50 >> $DOCS_DIR/diagrams/FOLDER_STRUCTURE.md

          echo '```' >> $DOCS_DIR/diagrams/FOLDER_STRUCTURE.md

          # Add directory purposes table
          cat >> $DOCS_DIR/diagrams/FOLDER_STRUCTURE.md << 'EOF'

          ## Key Directories

          | Directory | Purpose |
          |-----------|---------|
          | `.github/workflows/` | CI/CD pipeline definitions |
          | `src/` | Source code |
          | `tests/` or `test/` | Test files |
          | `docs/` | Documentation |
          | `docs/generated/` | Auto-generated docs (DocFlow) |
          EOF

      - name: Upload Structure
        uses: actions/upload-artifact@v4
        with:
          name: structure
          path: ${{ env.DOCS_DIR }}/diagrams/
          retention-days: 7

  generate-index:
    name: "Generate Documentation Index"
    needs: [generate-statistics, generate-structure]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Copy Artifacts to Docs
        run: |
          mkdir -p $DOCS_DIR/diagrams
          cp -r artifacts/statistics/* $DOCS_DIR/ 2>/dev/null || true
          cp -r artifacts/structure/* $DOCS_DIR/diagrams/ 2>/dev/null || true

      - name: Generate Index
        run: |
          cat > $DOCS_DIR/INDEX.md << 'EOF'
          # Documentation Index

          > Auto-generated by DocFlow. Do not edit manually.
          > Last updated: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## Quick Navigation

          | Document | Description | Type |
          |----------|-------------|------|
          | [README](../../README.md) | Project overview | Manual |
          | [CLAUDE.md](../../CLAUDE.md) | AI agent context | Manual |
          | [Statistics](STATISTICS.md) | File counts and repo stats | Auto |
          | [Folder Structure](diagrams/FOLDER_STRUCTURE.md) | Directory layout | Auto |

          ## Documentation Types

          - **Manual**: Updated by humans, reviewed in PRs
          - **Auto**: Generated by DocFlow workflow, refreshed weekly

          ## Contributing

          1. For manual docs: Create PR with changes to `docs/` folder
          2. For auto-generated: Update source files and DocFlow will regenerate
          3. Never edit files in `docs/generated/` directly
          EOF

      - name: Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/

          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "docs: auto-update generated documentation [skip ci]"
            git push
          fi

